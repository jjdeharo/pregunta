<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Cuestionarios Avanzado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-sN/J4BiiactO/EwkGryJmqDRCza7N4JWdSAc3LGoE7Psd7IeWHlHGHPAcn+Aq/4N" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1gAUA15SOMiCl0H8ascL4AU2dC1FfsMQA4RIwOjiQs" crossorigin="anonymous"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/Gf1Yp46Dc62IzeWYfkznxlMebdtnzaSOgAqfrRXpCW7IOtzn" crossorigin="anonymous"
        onload="renderizarElementosConFormulas()"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .hidden-important { display: none !important; }
        .form-check-input {
            appearance: none; -webkit-appearance: none; flex-shrink: 0;
            width: 1.25rem; height: 1.25rem;
            border: 2px solid #9ca3af;
            display: inline-block; position: relative;
            cursor: pointer; margin-right: 0.5rem;
        }
        .dark .form-check-input { border-color: #4b5563; }
        .form-check-input:checked { border-color: #4f46e5; background-color: #4f46e5; }
        .form-check-input.radio { border-radius: 50%; }
        .form-check-input.radio:checked::after { content: ''; width: 0.5rem; height: 0.5rem; border-radius: 50%; background: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .form-check-input.checkbox { border-radius: 0.25rem; }
        .form-check-input.checkbox:checked::after { content: '✓'; font-size: 0.8rem; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #pregunta-preview {
            min-height: 60px; padding: 1rem; border-radius: 0.375rem; 
            background-color: #f9fafb; margin-top: 0.75rem; 
            display: flex; align-items: center; justify-content: flex-start; 
            font-size: 1.1rem; border: 1px solid #e5e7eb; text-align: left; flex-wrap: wrap;
        }
        .dark #pregunta-preview { background-color: #1f2937; border-color: #4b5563; }
        .katex-display { margin: 0.5em 0; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-white">

    <div class="w-full max-w-4xl mx-auto p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 relative">
            <button id="theme-toggle" class="absolute top-6 right-6 p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
            <header class="mb-8 text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400">Editor de Cuestionarios</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Crea, edita y gestiona tus preguntas con fórmulas LaTeX.</p>
            </header>

            <form id="pregunta-form" class="mb-8 bg-gray-50 dark:bg-gray-900 p-6 rounded-lg">
                <input type="hidden" id="edit-index" value="-1">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label for="pregunta" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pregunta</label>
                            <textarea id="pregunta" rows="4" class="w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md p-2" placeholder="Usa $..$ o \(.. \) para fórmulas en línea y $$..$$ o \[..\] para bloques."></textarea>
                            <div id="pregunta-preview-container">
                                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mt-2 mb-1">Previsualización:</label>
                                <div id="pregunta-preview"></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3" id="respuestas-container">
                        </div>
                </div>
                <div class="mt-6 flex space-x-4">
                    <button type="submit" id="submit-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Añadir Pregunta</button>
                    <button type="button" id="cancel-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hidden-important">Cancelar</button>
                </div>
            </form>

            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-4 text-indigo-600 dark:text-indigo-400">Cuestionario Actual</h2>
                <div id="lista-preguntas" class="space-y-3 bg-gray-50 dark:bg-gray-900 p-4 rounded-lg max-h-72 overflow-y-auto">
                    </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                </div>
        </div>
    </div>

    <script>
        // --- FUNCIÓN GLOBAL PARA RENDERIZAR CON KATEX ---
        function renderizarElementosConFormulas() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '$', right: '$', display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- REFERENCIAS AL DOM ---
            const preguntaInput = document.getElementById('pregunta');
            const preguntaPreview = document.getElementById('pregunta-preview');
            const listaPreguntasContainer = document.getElementById('lista-preguntas');
            const form = document.getElementById('pregunta-form');
            const editIndexInput = document.getElementById('edit-index');
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            // ... (Añade aquí el resto de tus referencias al DOM que tenías: tipoPreguntaSelect, tiempoLimiteSelect, etc.)

            // --- ESTADO DE LA APLICACIÓN ---
            let preguntas = [];

            // --- FUNCIONES ---
            function renderizarPreviewFormula() {
                // Para la preview, solo renderizamos el contenido del div específico
                preguntaPreview.textContent = preguntaInput.value;
                if (window.renderMathInElement) {
                    renderMathInElement(preguntaPreview, {
                         delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '\\[', right: '\\]', display: true},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }
            
            function renderizarPreguntas() {
                listaPreguntasContainer.innerHTML = '';
                if (preguntas.length === 0) {
                    listaPreguntasContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Aún no has añadido ninguna pregunta.</p>';
                    return;
                }
                preguntas.forEach((p, index) => {
                    const el = document.createElement('div');
                    el.className = 'bg-gray-100 dark:bg-gray-800 p-3 rounded-md flex justify-between items-center';
                    // Se inserta el texto plano. La función global de renderizado se encargará de las fórmulas.
                    el.innerHTML = `
                        <div class="flex-grow mr-4 overflow-hidden">
                            <div class="pregunta-texto text-gray-800 dark:text-gray-200 truncate" title="${p.pregunta.replace(/"/g, '&quot;')}">${index + 1}. ${p.pregunta}</div>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button data-index="${index}" class="editar-btn ...">Editar</button>
                            <button data-index="${index}" class="eliminar-btn ...">Eliminar</button>
                        </div>`;
                    listaPreguntasContainer.appendChild(el);
                });
                // Una vez añadidas todas las preguntas al DOM, se le pide a KaTeX que renderice todo el contenedor
                renderizarElementosConFormulas();
            }

            // --- LÓGICA DEL FORMULARIO ---
            function gestionarSubmitFormulario(event) {
                event.preventDefault();
                // ... (Tu lógica para añadir/actualizar preguntas)
                // Ejemplo simple:
                const nuevaPregunta = {
                    pregunta: preguntaInput.value.trim(),
                    // ... el resto de tus propiedades
                };
                preguntas.push(nuevaPregunta);
                renderizarPreguntas();
                form.reset();
                renderizarPreviewFormula();
            }

            // --- EVENT LISTENERS ---
            preguntaInput.addEventListener('keyup', renderizarPreviewFormula);
            form.addEventListener('submit', gestionarSubmitFormulario);
            
            // --- INICIALIZACIÓN ---
            renderizarPreviewFormula(); // Limpia la preview al cargar
            renderizarPreguntas(); // Renderiza la lista inicial
        });
    </script>
</body>
</html>
